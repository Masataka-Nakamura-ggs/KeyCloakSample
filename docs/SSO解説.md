# KeyCloak + Next.js シングルサインオン（SSO）の実現方法

このプロジェクトでは、KeyCloakとNext.jsを連携させてシングルサインオン（SSO）を実現しています。以下では、その仕組みを解説します。

## シングルサインオン（SSO）とは

シングルサインオン（SSO）とは、1回の認証（ログイン）で複数のサービスやアプリケーションにアクセスできる仕組みです。ユーザーは一度だけIDとパスワードを入力するだけで、連携された複数のアプリケーションにシームレスにアクセスできるようになります。

## このプロジェクトでのSSOの実現方法

### 1. KeyCloakによる一元的な認証管理

このプロジェクトでは、KeyCloakが中央の認証サーバーとして機能しています。KeyCloakは以下の役割を担っています：

- ユーザー情報の管理
- 認証処理（ユーザー名とパスワードの検証）
- セッション管理
- トークン発行（JWT）

### 2. 認証フロー

1. ユーザーがNext.jsアプリケーションの保護されたルート（例: `/dashboard`）にアクセスします。
2. Next.jsのミドルウェアがセッションを確認し、認証されていない場合はKeyCloakのログインページにリダイレクトします。
3. ユーザーがKeyCloakでログインすると、KeyCloakはトークンを発行し、ユーザーをNext.jsアプリケーションにリダイレクトします。
4. Next.jsアプリケーションはトークンを検証し、有効であれば保護されたリソースへのアクセスを許可します。

### 3. 複数アプリケーションでのSSO

**重要ポイント:** 一度KeyCloakでログインすると、同じレルム（`my-app-realm`）に接続された他のアプリケーションにも、再度パスワードを入力することなくアクセスできます。

例えば：

1. ユーザーがこのNext.jsアプリケーションでKeyCloakを使ってログインします。
2. その後、同じKeyCloakレルム（`my-app-realm`）に接続された別のアプリケーション（例: 別のNext.jsアプリ、Reactアプリ、Springアプリなど）にアクセスすると、自動的に認証された状態となります。
3. これは、KeyCloakがブラウザのクッキーにセッション情報を保存し、同じレルムに接続されたアプリケーション間でその情報を共有するためです。

### 4. セキュリティの確保

SSOは便利である一方、一箇所からすべてのアプリにアクセスできるため、セキュリティ上の懸念もあります。しかし、KeyCloakは以下の機能でセキュリティを確保しています：

- JWTトークンによる安全な認証情報の伝達
- トークンの有効期限設定
- セッションタイムアウト
- 多要素認証（MFA）オプション
- アクセスポリシーの細かい設定

## まとめ

このサンプルプロジェクトでは、KeyCloakとNext.jsを連携させることで、シングルサインオン（SSO）を実現しています。ユーザーは一度KeyCloakでログインするだけで、同じレルムに接続された複数のアプリケーションにシームレスにアクセスできるようになります。これにより、ユーザー体験の向上とセキュリティの集中管理が実現されています。
