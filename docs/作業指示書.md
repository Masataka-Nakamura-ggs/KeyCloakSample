# 役割

あなたは、フルスタック開発のエキスパートです。特に、Next.js（App Router）と`next-auth` v5 (Auth.js) を使った認証実装、およびDockerによるサービス構築に深い知見を持っています。

# 背景と目標

私は、ReactベースのモダンなWebアプリケーション開発を学んでいます。認証基盤としてオープンソースで評価の高いKeyCloakを採用し、フロントエンドにはNext.jsを使いたいと考えています。

最終的な目標は、以下の要件をすべて満たす、実践的なサンプルプロジェクトの完全な手順とコードを生成することです。

1.  **Docker ComposeによるKeyCloak環境の構築:** ローカル開発用に、DockerでKeyCloakサーバーを簡単に起動・停止できるようにする。
2.  **Next.js (App Router) プロジェクトの構築:** 最新のNext.jsの機能（App Router）を使用する。
3.  **認証機能の実装:**
    * ユーザーがKeyCloakのログインページにリダイレクトされ、認証できる。
    * ログイン/ログアウト機能を実装する。
    * ログイン後は、トップページにユーザー名やEmailなどの情報を表示する。
4.  **アクセス制御の実装:**
    * `/dashboard` のような特定のページを「保護されたルート」とし、未認証のユーザーがアクセスした場合はログインページにリダイレクトする。
5.  **シングルサインオン (SSO) の実現:** KeyCloakが提供するSSOの仕組みをこの構成で実現する。

# 前提条件

* ローカルマシンにDockerおよびDocker Composeがインストール済みであること。
* Node.js (LTS版) と npm/pnpm/yarn がインストール済みであること。
* **Next.jsとViteについて:** ユーザーは「Next.js + Vite」と述べましたが、これらは通常併用されるものではありません。今回は、Reactのフルスタックフレームワークである**Next.js**に焦点を当ててプロジェクトを構築してください。

# タスク: ステップ・バイ・ステップガイドの生成

以下のステップに沿って、詳細な手順と、各ステップで必要となる完全なコード（コピー＆ペーストで動作するもの）を生成してください。

---

### **ステップ1: Docker ComposeによるKeyCloakのセットアップ**

1.  プロジェクト用のルートディレクトリを作成し、その中に`docker-compose.yml`ファイルを配置する手順を説明してください。
2.  KeyCloakを起動するための`docker-compose.yml`ファイルの内容を記述してください。
    * KeyCloakのバージョンは比較的新しいもの（例: 24.x）を指定してください。
    * KeyCloakの管理者ユーザー（`admin`）とパスワードを環境変数で設定するようにしてください。
3.  コンテナを起動し、KeyCloakの管理コンソール (`http://localhost:8080`) にアクセスするまでのコマンドを記述してください。

### **ステップ2: KeyCloakでのレルムとクライアント設定**

1.  KeyCloak管理コンソールにログイン後、「Master」レルムではなく、新しいレルム（例: `my-app-realm`）を作成する手順を説明してください。
2.  作成したレルム内に、Next.jsアプリケーション用の新しいクライアント（例: `nextjs-client`）を作成する手順を詳細に説明してください。設定すべき重要な項目をリストアップしてください。
    * **Client ID:** `nextjs-client`
    * **Client authentication:** On
    * **Valid redirect URIs:** `http://localhost:3000/api/auth/*`
    * **Web origins:** `http://localhost:3000`
3.  作成したクライアントの`Credentials`タブから**Client secret**を取得する方法を説明してください。
4.  テスト用のユーザー（例: `testuser` / `password`）を作成し、Emailも設定する手順を説明してください。

### **ステップ3: Next.jsプロジェクトのセットアップと`next-auth`の導入**

1.  `create-next-app`を使って、TypeScriptを使用した新しいNext.jsプロジェクトを作成するコマンドを記述してください。
2.  `next-auth@beta`（v5/Auth.js）をプロジェクトにインストールするコマンドを記述してください。
3.  プロジェクトのルートに、環境変数を管理するための`.env.local`ファイルを作成し、以下のKeyCloak情報を格納するよう指示してください。この際、ステップ2で設定した値を使うように案内してください。

```

AUTH\_SECRET="your-secret" \# openssl rand -base64 32 で生成した値を推奨
AUTH\_KEYCLOAK\_ID=nextjs-client
AUTH\_KEYCLOAK\_SECRET=ここにClient Secretを記述
AUTH\_KEYCLOAK\_ISSUER=http://localhost:8080/realms/my-app-realm

```

### **ステップ4: Next.jsとKeyCloakの連携 (`auth.ts`の作成)**

1.  プロジェクトのルートに`auth.ts`ファイルを作成します。
2.  `auth.ts`ファイルに、`next-auth`の`NextAuth`コンフィグを記述してください。
    * `Keycloak`プロバイダーをインポートし、`.env.local`から読み込んだ環境変数を使って設定します。
    * `signIn`, `signOut`, `auth`, `handlers`をエクスポートします。

### **ステップ5: APIルートとミドルウェアの作成**

1.  `app/api/auth/[...nextauth]/route.ts`ファイルを作成し、`auth.ts`からエクスポートした`handlers`をエクスポートするコードを記述してください。
2.  プロジェクトのルートに`middleware.ts`ファイルを作成し、保護したいルート（例: `/dashboard`）へのアクセスを制御するコードを記述してください。
    * 未認証ユーザーが`/dashboard`にアクセスした場合、自動的にKeyCloakのログインページにリダイレクトされるようにします。

### **ステップ6: フロントエンドコンポーネントの実装**

1.  **ログイン/ログアウトボタン:**
    * ログイン状態に応じて表示が変わるコンポーネント（例: `LoginButton.tsx`）を作成してください。
    * ログイン処理（`signIn`）とログアウト処理（`signOut`）を呼び出すサーバーアクションを含めてください。
2.  **ユーザー情報の表示:**
    * `app/page.tsx`（トップページ）を編集し、`auth()`関数を使ってセッション情報を取得し、「ようこそ、{ユーザー名}さん！」のように表示するコードを記述してください。未ログインの場合はログインボタンを表示するようにしてください。
3.  **保護されたページの作成:**
    * `app/dashboard/page.tsx`を作成してください。
    * このページにも`auth()`関数を配置し、ログインユーザーの詳細情報（Emailなど）を表示する簡単な内容を記述してください。このページはミドルウェアによって保護されているため、ログインが必須であることをコメントで補足してください。
4.  **レイアウトの更新:**
    * `app/layout.tsx`に、作成したログイン/ログアウトボタンコンポーネントを配置してください。

### **ステップ7: シングルサインオン(SSO)についての解説**

最後に、この構成がどのようにしてシングルサインオンを実現しているのかを簡潔に解説してください。
「一度KeyCloakでログインすれば、同じレルムに接続された他のアプリケーションにも再度パスワードを入力することなくアクセスできる」という点を明確に説明してください。

